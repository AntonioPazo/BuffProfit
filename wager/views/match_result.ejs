<%- include('partials/header', { title: 'Match Result', username: username }) %>

<div class="mrs-main-container">
    <!-- Background Effects -->
    <div class="mrs-bg-effects">
        <div class="mrs-gradient-orb-1"></div>
        <div class="mrs-gradient-orb-2"></div>
        <div class="mrs-gradient-orb-3"></div>
    </div>
    
    <div class="mrs-content-wrapper">
        <!-- Sidebar -->
        <div class="mrs-sidebar">
            <!-- Match Info Section -->
            <div class="mrs-sidebar-section">
                <div class="mrs-section-header">
                    <div class="mrs-section-icon">
                        <i class="fas fa-gamepad"></i>
                    </div>
                    <h3 class="mrs-section-title">INFORMACI√ìN DE LA PARTIDA</h3>
                </div>
                
                <div class="mrs-match-info-grid">
                    <div class="mrs-info-item">
                        <div class="mrs-info-label">
                            <i class="fas fa-cog"></i>
                            Modo
                        </div>
                        <div class="mrs-info-value"><%= match.mode %></div>
                    </div>
                    
                    <div class="mrs-info-item">
                        <div class="mrs-info-label">
                            <i class="fas fa-map"></i>
                            Mapa
                        </div>
                        <div class="mrs-info-value"><%= match.map %></div>
                    </div>
                    
                    <div class="mrs-info-item">
                        <div class="mrs-info-label">
                            <i class="fas fa-sitemap"></i>
                            Formato
                        </div>
                        <div class="mrs-info-value"><%= match.format %></div>
                    </div>
                    
                    <div class="mrs-info-item">
                        <div class="mrs-info-label">
                            <i class="fas fa-globe"></i>
                            Regi√≥n
                        </div>
                        <div class="mrs-info-value"><%= match.region.toUpperCase() %></div>
                    </div>
                    
                    <div class="mrs-info-item">
                        <div class="mrs-info-label">
                            <i class="fas fa-star"></i>
                            Nivel
                        </div>
                        <div class="mrs-info-value"><%= match.skill_level %></div>
                    </div>
                    
                    <div class="mrs-info-item mrs-credits-highlight">
                        <div class="mrs-info-label">
                            <i class="fas fa-coins"></i>
                            Cr√©ditos
                        </div>
                        <div class="mrs-info-value"><%= match.creditos %></div>
                    </div>
                    
                    <div class="mrs-info-item">
                        <div class="mrs-info-label">
                            <i class="fas fa-hashtag"></i>
                            Game ID
                        </div>
                        <div class="mrs-info-value"><%= match.idGameLol %></div>
                    </div>
                </div>
            </div>
            
            <!-- Players Section -->
            <div class="mrs-sidebar-section">
                <div class="mrs-section-header">
                    <div class="mrs-section-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3 class="mrs-section-title">JUGADORES</h3>
                </div>
                
                <div class="mrs-players-container">
                    <div class="mrs-player-card mrs-blue-player">
                        <div class="mrs-player-header">
                            <div class="mrs-player-avatar mrs-blue-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="mrs-player-info">
                                <div class="mrs-player-label">JUGADOR AZUL</div>
                                <div class="mrs-player-name"><%= match.blue_username %></div>
                            </div>
                        </div>
                        <div class="mrs-player-stats">
                            <div class="mrs-reputation-badge">
                                <i class="fas fa-thumbs-up"></i>
                                <span>Reputaci√≥n: <%= match.blue_reputation %></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mrs-vs-divider">
                        <span>VS</span>
                    </div>
                    
                    <div class="mrs-player-card mrs-red-player">
                        <div class="mrs-player-header">
                            <div class="mrs-player-avatar mrs-red-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="mrs-player-info">
                                <div class="mrs-player-label">JUGADOR ROJO</div>
                                <div class="mrs-player-name"><%= match.red_username %></div>
                            </div>
                        </div>
                        <div class="mrs-player-stats">
                            <div class="mrs-reputation-badge">
                                <i class="fas fa-thumbs-up"></i>
                                <span>Reputaci√≥n: <%= match.red_reputation %></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="mrs-main-content">
            <!-- Header Navigation -->
            <div class="mrs-top-navigation">
                <div class="mrs-nav-content">
                    <h1 class="mrs-page-title">RESULTADO DE LA PARTIDA</h1>
                    <a href="/matchfinder" class="mrs-back-link">
                        <i class="fas fa-arrow-left"></i>
                        <span>Volver al Matchfinder</span>
                    </a>
                </div>
            </div>
            
            <!-- Alerts -->
            <% if (message) { %>
                <div class="mrs-alert mrs-alert-success">
                    <div class="mrs-alert-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="mrs-alert-content">
                        <% if (message === 'result-submitted') { %>
                            <strong>¬°Resultado enviado!</strong> Tu resultado ha sido enviado. Esperando la confirmaci√≥n del otro jugador.
                        <% } else if (message === 'result-confirmed') { %>
                            <strong>¬°Resultado confirmado!</strong> Ambos jugadores est√°n de acuerdo.
                        <% } else if (message === 'result-disputed') { %>
                            <strong>Disputa registrada.</strong> Hay una disputa en el resultado. Se requieren pruebas para resolver.
                        <% } else if (message === 'rating-submitted') { %>
                            <strong>¬°Calificaci√≥n enviada!</strong> Has calificado a tu oponente correctamente.
                        <% } else { %>
                            <%= message %>
                        <% } %>
                    </div>
                </div>
            <% } %>
            
            <% if (error) { %>
                <div class="mrs-alert mrs-alert-error">
                    <div class="mrs-alert-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="mrs-alert-content">
                        <% if (error === 'already-has-result') { %>
                            <strong>Error:</strong> Esta partida ya tiene un resultado registrado.
                        <% } else if (error === 'server-error') { %>
                            <strong>Error:</strong> Error del servidor. Int√©ntalo de nuevo m√°s tarde.
                        <% } else if (error === 'already-rated') { %>
                            <strong>Error:</strong> Ya has calificado a tu oponente.
                        <% } else if (error === 'match-not-completed') { %>
                            <strong>Error:</strong> La partida debe completarse antes de calificar a tu oponente.
                        <% } else { %>
                            <strong>Error:</strong> <%= error %>
                        <% } %>
                    </div>
                </div>
            <% } %>
            
            <% if (joined) { %>
                <div class="mrs-alert mrs-alert-info">
                    <div class="mrs-alert-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="mrs-alert-content">
                        <strong>¬°Te has unido!</strong> Te has unido a esta partida. Juega la partida y luego reporta el resultado.
                    </div>
                </div>
            <% } %>
            
            <!-- Result Container -->
            <div class="mrs-result-container">
                <% if (match.winner) { %>
                    <!-- Final Result -->
                    <div class="mrs-result-announced">
                        <div class="mrs-result-header">
                            <div class="mrs-result-icon">
                                <i class="fas fa-trophy"></i>
                            </div>
                            <h3>Resultado Final</h3>
                        </div>
                        
                        <div class="mrs-winner-announcement">
                            <% if (match.winner === match.blue_summoner_id) { %>
                                <div class="mrs-winner mrs-blue-winner">
                                    <div class="mrs-winner-crown">
                                        <i class="fas fa-crown"></i>
                                    </div>
                                    <div class="mrs-winner-info">
                                        <div class="mrs-winner-label">GANADOR</div>
                                        <div class="mrs-winner-name"><%= match.blue_username %></div>
                                        <div class="mrs-winner-team">Equipo Azul</div>
                                    </div>
                                </div>
                            <% } else if (match.winner === match.red_summoner_id) { %>
                                <div class="mrs-winner mrs-red-winner">
                                    <div class="mrs-winner-crown">
                                        <i class="fas fa-crown"></i>
                                    </div>
                                    <div class="mrs-winner-info">
                                        <div class="mrs-winner-label">GANADOR</div>
                                        <div class="mrs-winner-name"><%= match.red_username %></div>
                                        <div class="mrs-winner-team">Equipo Rojo</div>
                                    </div>
                                </div>
                            <% } %>
                        </div>
                        
                        <% if (userWon !== null) { %>
                            <div class="mrs-user-result">
                                <% if (userWon) { %>
                                    <div class="mrs-result-message mrs-win">
                                        <div class="mrs-result-message-icon">
                                            <i class="fas fa-trophy"></i>
                                        </div>
                                        <div class="mrs-result-message-content">
                                            <h4>¬°Has ganado la partida!</h4>
                                            <p>Has ganado <strong><%= creditsWon %> cr√©ditos</strong>.</p>
                                        </div>
                                    </div>
                                <% } else { %>
                                    <div class="mrs-result-message mrs-loss">
                                        <div class="mrs-result-message-icon">
                                            <i class="fas fa-heart-broken"></i>
                                        </div>
                                        <div class="mrs-result-message-content">
                                            <h4>Has perdido la partida</h4>
                                            <p>Mejor suerte la pr√≥xima vez.</p>
                                        </div>
                                    </div>
                                <% } %>
                            </div>
                        <% } %>
                        
                        <!-- Rating Section -->
                        <% if (!hasRatedOpponent) { %>
                            <div class="mrs-rating-section">
                                <div class="mrs-rating-header">
                                    <div class="mrs-rating-icon">
                                        <i class="fas fa-star"></i>
                                    </div>
                                    <div class="mrs-rating-title">
                                        <h4>Califica a tu oponente</h4>
                                        <p>Tu calificaci√≥n ayuda a mantener una comunidad saludable</p>
                                    </div>
                                </div>
                                
                                <form action="/rate-opponent/<%= match.id_game %>" method="POST" class="mrs-rating-form">
                                    <div class="mrs-rating-options">
                                        <div class="mrs-rating-option">
                                            <input type="radio" id="mrsVeryPositive" name="rating" value="very_positive">
                                            <label for="mrsVeryPositive" class="mrs-rating-label mrs-very-positive">
                                                <div class="mrs-rating-emoji">üòç</div>
                                                <div class="mrs-rating-text">
                                                    <span class="mrs-rating-name">Muy Positivo</span>
                                                    <span class="mrs-rating-points">+2 puntos</span>
                                                </div>
                                            </label>
                                        </div>
                                        
                                        <div class="mrs-rating-option">
                                            <input type="radio" id="mrsPositive" name="rating" value="positive">
                                            <label for="mrsPositive" class="mrs-rating-label mrs-positive">
                                                <div class="mrs-rating-emoji">üòä</div>
                                                <div class="mrs-rating-text">
                                                    <span class="mrs-rating-name">Positivo</span>
                                                    <span class="mrs-rating-points">+1 punto</span>
                                                </div>
                                            </label>
                                        </div>
                                        
                                        <div class="mrs-rating-option">
                                            <input type="radio" id="mrsNeutral" name="rating" value="neutral" checked>
                                            <label for="mrsNeutral" class="mrs-rating-label mrs-neutral">
                                                <div class="mrs-rating-emoji">üòê</div>
                                                <div class="mrs-rating-text">
                                                    <span class="mrs-rating-name">Neutro</span>
                                                    <span class="mrs-rating-points">0 puntos</span>
                                                </div>
                                            </label>
                                        </div>
                                        
                                        <div class="mrs-rating-option">
                                            <input type="radio" id="mrsNegative" name="rating" value="negative">
                                            <label for="mrsNegative" class="mrs-rating-label mrs-negative">
                                                <div class="mrs-rating-emoji">üò†</div>
                                                <div class="mrs-rating-text">
                                                    <span class="mrs-rating-name">Negativo</span>
                                                    <span class="mrs-rating-points">-1 punto</span>
                                                </div>
                                            </label>
                                        </div>
                                        
                                        <div class="mrs-rating-option">
                                            <input type="radio" id="mrsVeryNegative" name="rating" value="very_negative">
                                            <label for="mrsVeryNegative" class="mrs-rating-label mrs-very-negative">
                                                <div class="mrs-rating-emoji">ü§¨</div>
                                                <div class="mrs-rating-text">
                                                    <span class="mrs-rating-name">Muy Negativo</span>
                                                    <span class="mrs-rating-points">-2 puntos</span>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="mrs-rating-actions">
                                        <button type="submit" class="mrs-btn mrs-btn-primary">
                                            <i class="fas fa-paper-plane"></i>
                                            <span>Enviar Calificaci√≥n</span>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        <% } else { %>
                            <div class="mrs-already-rated">
                                <div class="mrs-already-rated-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <p>Ya has calificado a tu oponente.</p>
                            </div>
                        <% } %>
                    </div>
                <% } else if (match.dispute) { %>
                    <!-- Disputed Result -->
                    <div class="mrs-result-disputed">
                        <div class="mrs-dispute-header">
                            <div class="mrs-dispute-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="mrs-dispute-title">
                                <h3>Disputa de Resultado</h3>
                                <p>Hay una disputa en el resultado de esta partida. Los administradores revisar√°n las pruebas proporcionadas.</p>
                            </div>
                        </div>
                        
                        <div class="mrs-dispute-details">
                            <!-- Blue Player Dispute -->
                            <div class="mrs-dispute-player mrs-blue-dispute">
                                <div class="mrs-dispute-player-header">
                                    <div class="mrs-dispute-player-avatar">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <div class="mrs-dispute-player-info">
                                        <h4><%= match.blue_username %></h4>
                                        <span class="mrs-dispute-team">Equipo Azul</span>
                                    </div>
                                </div>
                                
                                <div class="mrs-dispute-report">
                                    <div class="mrs-report-label">Report√≥ como ganador:</div>
                                    <div class="mrs-report-value">
                                        <%= match.blue_reported_winner === match.blue_summoner_id ? match.blue_username + ' (Azul)' : match.red_username + ' (Rojo)' %>
                                    </div>
                                </div>
                                
                                <% if (match.blue_proof_images) { %>
                                    <div class="mrs-proof-section">
                                        <div class="mrs-proof-header">
                                            <i class="fas fa-camera"></i>
                                            <span>Pruebas aportadas</span>
                                        </div>
                                        <div class="mrs-proof-gallery">
                                            <% JSON.parse(match.blue_proof_images).forEach((imagePath, index) => { %>
                                                <div class="mrs-proof-item" onclick="mrsOpenImageModal('<%= imagePath %>')">
                                                    <img src="<%= imagePath %>" alt="Prueba <%= index + 1 %>" class="mrs-proof-image">
                                                    <div class="mrs-proof-overlay">
                                                        <i class="fas fa-search-plus"></i>
                                                    </div>
                                                </div>
                                            <% }); %>
                                        </div>
                                    </div>
                                <% } %>
                            </div>
                            
                            <!-- Red Player Dispute -->
                            <div class="mrs-dispute-player mrs-red-dispute">
                                <div class="mrs-dispute-player-header">
                                    <div class="mrs-dispute-player-avatar">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <div class="mrs-dispute-player-info">
                                        <h4><%= match.red_username %></h4>
                                        <span class="mrs-dispute-team">Equipo Rojo</span>
                                    </div>
                                </div>
                                
                                <div class="mrs-dispute-report">
                                    <div class="mrs-report-label">Report√≥ como ganador:</div>
                                    <div class="mrs-report-value">
                                        <%= match.red_reported_winner === match.blue_summoner_id ? match.blue_username + ' (Azul)' : match.red_username + ' (Rojo)' %>
                                    </div>
                                </div>
                                
                                <% if (match.red_proof_images) { %>
                                    <div class="mrs-proof-section">
                                        <div class="mrs-proof-header">
                                            <i class="fas fa-camera"></i>
                                            <span>Pruebas aportadas</span>
                                        </div>
                                        <div class="mrs-proof-gallery">
                                            <% JSON.parse(match.red_proof_images).forEach((imagePath, index) => { %>
                                                <div class="mrs-proof-item" onclick="mrsOpenImageModal('<%= imagePath %>')">
                                                    <img src="<%= imagePath %>" alt="Prueba <%= index + 1 %>" class="mrs-proof-image">
                                                    <div class="mrs-proof-overlay">
                                                        <i class="fas fa-search-plus"></i>
                                                    </div>
                                                </div>
                                            <% }); %>
                                        </div>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    </div>
                <% } else { %>
                    <% if ((isBluePlayer && !match.reported_by_blue) || (isRedPlayer && !match.reported_by_red)) { %>
                        <!-- Result Form -->
                        <div class="mrs-result-form">
                            <div class="mrs-form-header">
                                <div class="mrs-form-icon">
                                    <i class="fas fa-flag-checkered"></i>
                                </div>
                                <div class="mrs-form-title">
                                    <h3>Reportar Resultado</h3>
                                    <p>Selecciona el ganador de la partida y opcionalmente sube pruebas</p>
                                </div>
                            </div>
                            
                            <form id="mrsResultForm" action="/submit-result/<%= match.id_game %>" method="POST" enctype="multipart/form-data" class="mrs-form">
                                <div class="mrs-form-group">
                                    <label class="mrs-form-label">¬øQui√©n gan√≥ la partida?</label>
                                    <div class="mrs-winner-options">
                                        <div class="mrs-winner-option">
                                            <input type="radio" id="mrsBlueWinner" name="winner" value="<%= match.blue_summoner_id %>" required>
                                            <label for="mrsBlueWinner" class="mrs-winner-label mrs-blue-winner-option">
                                                <div class="mrs-winner-option-avatar mrs-blue-avatar">
                                                    <i class="fas fa-user"></i>
                                                </div>
                                                <div class="mrs-winner-option-info">
                                                    <span class="mrs-winner-option-name"><%= match.blue_username %></span>
                                                    <span class="mrs-winner-option-team">Equipo Azul</span>
                                                </div>
                                                <div class="mrs-winner-option-check">
                                                    <i class="fas fa-check"></i>
                                                </div>
                                            </label>
                                        </div>
                                        
                                        <div class="mrs-winner-option">
                                            <input type="radio" id="mrsRedWinner" name="winner" value="<%= match.red_summoner_id %>" required>
                                            <label for="mrsRedWinner" class="mrs-winner-label mrs-red-winner-option">
                                                <div class="mrs-winner-option-avatar mrs-red-avatar">
                                                    <i class="fas fa-user"></i>
                                                </div>
                                                <div class="mrs-winner-option-info">
                                                    <span class="mrs-winner-option-name"><%= match.red_username %></span>
                                                    <span class="mrs-winner-option-team">Equipo Rojo</span>
                                                </div>
                                                <div class="mrs-winner-option-check">
                                                    <i class="fas fa-check"></i>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mrs-form-group">
                                    <label for="mrsProofImages" class="mrs-form-label">
                                        <i class="fas fa-camera"></i>
                                        Im√°genes de prueba (opcional)
                                    </label>
                                    <div class="mrs-form-help">
                                        Sube capturas de pantalla del resultado de la partida. Esto ser√° necesario si hay una disputa.
                                    </div>
                                    
                                    <div class="mrs-file-upload-area" id="mrsFileUploadArea">
                                        <input type="file" id="mrsProofImages" name="proof_images" multiple accept="image/*" class="mrs-file-input">
                                        <div class="mrs-file-upload-content">
                                            <div class="mrs-file-upload-icon">
                                                <i class="fas fa-cloud-upload-alt"></i>
                                            </div>
                                            <div class="mrs-file-upload-text">
                                                <span class="mrs-file-upload-main">Arrastra tus im√°genes aqu√≠ o haz clic para seleccionar</span>
                                                <span class="mrs-file-upload-sub">PNG, JPG, GIF hasta 5MB cada una</span>
                                            </div>
                                        </div>
                                        <div class="mrs-file-preview-container" id="mrsFilePreviewContainer"></div>
                                    </div>
                                </div>
                                
                                <div class="mrs-form-actions">
                                    <button type="submit" class="mrs-btn mrs-btn-primary">
                                        <i class="fas fa-paper-plane"></i>
                                        <span>Enviar Resultado</span>
                                        <div class="mrs-btn-loading">
                                            <i class="fas fa-spinner fa-spin"></i>
                                        </div>
                                    </button>
                                </div>
                            </form>
                        </div>
                    <% } else if ((isBluePlayer && match.reported_by_blue) || (isRedPlayer && match.reported_by_red)) { %>
                        <!-- Waiting Result -->
                        <div class="mrs-waiting-result">
                            <div class="mrs-waiting-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="mrs-waiting-content">
                                <h3>Resultado Enviado</h3>
                                <p>Has reportado el resultado de esta partida. Esperando la confirmaci√≥n del otro jugador.</p>
                                
                                <div class="mrs-reported-winner">
                                    <span class="mrs-reported-label">Reportaste como ganador:</span>
                                    <span class="mrs-reported-value">
                                        <% if (isBluePlayer && match.reported_by_blue) { %>
                                            <%= match.blue_reported_winner === match.blue_summoner_id ? match.blue_username + ' (Azul)' : match.red_username + ' (Rojo)' %>
                                        <% } else if (isRedPlayer && match.reported_by_red) { %>
                                            <%= match.red_reported_winner === match.blue_summoner_id ? match.blue_username + ' (Azul)' : match.red_username + ' (Rojo)' %>
                                        <% } %>
                                    </span>
                                </div>
                            </div>
                        </div>
                    <% } %>
                <% } %>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div id="mrsImageModal" class="mrs-modal">
    <div class="mrs-modal-overlay" onclick="mrsCloseImageModal()"></div>
    <div class="mrs-modal-container">
        <div class="mrs-modal-header">
            <h3 class="mrs-modal-title">Prueba de la Partida</h3>
            <button class="mrs-modal-close" onclick="mrsCloseImageModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="mrs-modal-body">
            <img id="mrsModalImage" src="/placeholder.svg" alt="Prueba ampliada" class="mrs-modal-image">
        </div>
    </div>
</div>

<script>
// Global functions for match result management
function mrsOpenImageModal(imagePath) {
    const modal = document.getElementById('mrsImageModal');
    const modalImg = document.getElementById('mrsModalImage');
    modal.style.display = 'block';
    modalImg.src = imagePath;
    document.body.style.overflow = 'hidden';
}

function mrsCloseImageModal() {
    const modal = document.getElementById('mrsImageModal');
    modal.style.display = 'none';
    document.body.style.overflow = '';
}

document.addEventListener('DOMContentLoaded', function() {
    // File upload functionality
    const fileUploadArea = document.getElementById('mrsFileUploadArea');
    const fileInput = document.getElementById('mrsProofImages');
    const filePreviewContainer = document.getElementById('mrsFilePreviewContainer');
    const uploadContent = document.querySelector('.mrs-file-upload-content');
    
    let selectedFiles = [];
    
    // Drag and drop functionality
    if (fileUploadArea) {
        fileUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('mrs-dragover');
        });
        
        fileUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('mrs-dragover');
        });
        
        fileUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('mrs-dragover');
            
            const files = Array.from(e.dataTransfer.files);
            handleFileSelection(files);
        });
    }
    
    // File input change
    if (fileInput) {
        fileInput.addEventListener('change', function() {
            const files = Array.from(this.files);
            handleFileSelection(files);
        });
    }
    
    function handleFileSelection(files) {
        // Filter only image files
        const imageFiles = files.filter(file => file.type.match('image.*'));
        
        // Validate file sizes
        const validFiles = imageFiles.filter(file => {
            if (file.size > 5 * 1024 * 1024) {
                alert(`El archivo ${file.name} es demasiado grande. El tama√±o m√°ximo es 5MB.`);
                return false;
            }
            return true;
        });
        
        // Add to selected files
        selectedFiles = [...selectedFiles, ...validFiles];
        
        // Update file input
        updateFileInput();
        
        // Show previews
        showFilePreviews();
    }
    
    function updateFileInput() {
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        fileInput.files = dt.files;
    }
    
    function showFilePreviews() {
        filePreviewContainer.innerHTML = '';
        
        if (selectedFiles.length > 0) {
            uploadContent.style.display = 'none';
            
            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'mrs-file-preview';
                    previewDiv.innerHTML = `
                        <img src="${e.target.result}" alt="Preview ${index + 1}">
                        <button type="button" class="mrs-file-remove" onclick="mrsRemoveFile(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    filePreviewContainer.appendChild(previewDiv);
                };
                reader.readAsDataURL(file);
            });
        } else {
            uploadContent.style.display = 'block';
        }
    }
    
    // Make remove function global
    window.mrsRemoveFile = function(index) {
        selectedFiles.splice(index, 1);
        updateFileInput();
        showFilePreviews();
    };
    
    // Form submission with loading state
    const resultForm = document.getElementById('mrsResultForm');
    if (resultForm) {
        resultForm.addEventListener('submit', function(e) {
            const selectedWinner = this.querySelector('input[name="winner"]:checked');
            
            if (!selectedWinner) {
                e.preventDefault();
                alert('Por favor, selecciona el ganador de la partida.');
                return;
            }
            
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.classList.add('mrs-loading');
            submitBtn.disabled = true;
        });
    }
    
    // Rating form submission with loading state
    const ratingForm = document.querySelector('.mrs-rating-form');
    if (ratingForm) {
        ratingForm.addEventListener('submit', function(e) {
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.classList.add('mrs-loading');
            submitBtn.disabled = true;
        });
    }
    
    // Close modal on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            mrsCloseImageModal();
        }
    });
    
    // Animate elements on load
    const cards = document.querySelectorAll('.mrs-sidebar-section, .mrs-result-container');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            card.style.transition = 'all 0.6s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 200 + 300);
    });
    
    // Auto-hide alerts after 5 seconds
    const alerts = document.querySelectorAll('.mrs-alert');
    alerts.forEach(alert => {
        setTimeout(() => {
            alert.style.opacity = '0';
            alert.style.transform = 'translateY(-10px)';
            setTimeout(() => {
                alert.remove();
            }, 300);
        }, 5000);
    });
});
</script>

<%- include('partials/footer') %>