<%- include('partials/header', { title: 'Match Result', username: username }) %>

<div class="main-content">
    <div class="sidebar">
        <div class="sidebar-section">
            <h3 class="sidebar-title">MATCH INFO</h3>
            <div class="match-info-sidebar">
                <p><strong>Mode:</strong> <%= match.mode %></p>
                <p><strong>Map:</strong> <%= match.map %></p>
                <p><strong>Format:</strong> <%= match.format %></p>
                <p><strong>Region:</strong> <%= match.region.toUpperCase() %></p>
                <p><strong>Skill Level:</strong> <%= match.skill_level %></p>
                <p><strong>Credits:</strong> <%= match.creditos %></p>
                <p><strong>Game ID:</strong> <%= match.idGameLol %></p>
            </div>
        </div>
        <div class="sidebar-section">
            <h3 class="sidebar-title">PLAYERS</h3>
            <div class="players-info">
                <div class="player blue-player">
                    <div class="player-label">BLUE PLAYER</div>
                    <div class="player-name"><%= match.blue_username %></div>
                    <div class="player-reputation">Reputation: <%= match.blue_reputation %></div>
                </div>
                <div class="player red-player">
                    <div class="player-label">RED PLAYER</div>
                    <div class="player-name"><%= match.red_username %></div>
                    <div class="player-reputation">Reputation: <%= match.red_reputation %></div>
                </div>
            </div>
        </div>
    </div>
    <div class="content">
        <div class="top-bar">
            <h2 class="page-title">MATCH RESULT</h2>
            <div class="view-options">
                <a href="/matchfinder" class="nav-link">← Back to Matchfinder</a>
            </div>
        </div>
        
        <% if (message) { %>
            <div class="alert alert-success">
                <% if (message === 'result-submitted') { %>
                    Tu resultado ha sido enviado. Esperando la confirmación del otro jugador.
                <% } else if (message === 'result-confirmed') { %>
                    ¡Resultado confirmado! Ambos jugadores están de acuerdo.
                <% } else if (message === 'result-disputed') { %>
                    Hay una disputa en el resultado. Se requieren pruebas para resolver.
                <% } else if (message === 'rating-submitted') { %>
                    Has calificado a tu oponente correctamente.
                <% } else { %>
                    <%= message %>
                <% } %>
            </div>
        <% } %>
        
        <% if (error) { %>
            <div class="alert alert-error">
                <% if (error === 'already-has-result') { %>
                    Esta partida ya tiene un resultado registrado.
                <% } else if (error === 'server-error') { %>
                    Error del servidor. Inténtalo de nuevo más tarde.
                <% } else if (error === 'already-rated') { %>
                    Ya has calificado a tu oponente.
                <% } else if (error === 'match-not-completed') { %>
                    La partida debe completarse antes de calificar a tu oponente.
                <% } else { %>
                    <%= error %>
                <% } %>
            </div>
        <% } %>
        
        <% if (joined) { %>
            <div class="alert alert-info">
                Te has unido a esta partida. Juega la partida y luego reporta el resultado.
            </div>
        <% } %>
        
        <div class="result-container">
            <% if (match.winner) { %>
                <div class="result-announced">
                    <h3>Resultado Final</h3>
                    <div class="winner-announcement">
                        <% if (match.winner === match.blue_summoner_id) { %>
                            <div class="winner blue-winner">
                                <div class="winner-label">GANADOR</div>
                                <div class="winner-name"><%= match.blue_username %> (Blue)</div>
                            </div>
                        <% } else if (match.winner === match.red_summoner_id) { %>
                            <div class="winner red-winner">
                                <div class="winner-label">GANADOR</div>
                                <div class="winner-name"><%= match.red_username %> (Red)</div>
                            </div>
                        <% } %>
                    </div>
                    
                    <% if (userWon !== null) { %>
                        <div class="user-result">
                            <% if (userWon) { %>
                                <div class="result-message win">
                                    <h4>¡Has ganado la partida!</h4>
                                    <p>Has ganado <%= creditsWon %> créditos.</p>
                                </div>
                            <% } else { %>
                                <div class="result-message loss">
                                    <h4>Has perdido la partida</h4>
                                    <p>Mejor suerte la próxima vez.</p>
                                </div>
                            <% } %>
                        </div>
                    <% } %>
                    
                    <% if (!hasRatedOpponent) { %>
                        <div class="rate-opponent">
                            <h4>Califica a tu oponente</h4>
                            <form action="/rate-opponent/<%= match.id_game %>" method="POST">
                                <div class="rating-options">
                                    <div class="rating-option">
                                        <input type="radio" id="very_positive" name="rating" value="very_positive">
                                        <label for="very_positive">Muy Positivo (+2)</label>
                                    </div>
                                    <div class="rating-option">
                                        <input type="radio" id="positive" name="rating" value="positive">
                                        <label for="positive">Positivo (+1)</label>
                                    </div>
                                    <div class="rating-option">
                                        <input type="radio" id="neutral" name="rating" value="neutral" checked>
                                        <label for="neutral">Neutro (0)</label>
                                    </div>
                                    <div class="rating-option">
                                        <input type="radio" id="negative" name="rating" value="negative">
                                        <label for="negative">Negativo (-1)</label>
                                    </div>
                                    <div class="rating-option">
                                        <input type="radio" id="very_negative" name="rating" value="very_negative">
                                        <label for="very_negative">Muy Negativo (-2)</label>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary" href="/matchfinder" >Enviar Calificación</button>
                            </form>
                        </div>
                    <% } else { %>
                        <div class="already-rated">
                            <p>Ya has calificado a tu oponente.</p>
                        </div>
                    <% } %>
                </div>
            <% } else if (match.dispute) { %>
                <div class="result-disputed">
                    <h3>Disputa de Resultado</h3>
                    <p>Hay una disputa en el resultado de esta partida. Los administradores revisarán las pruebas proporcionadas.</p>
                    
                    <div class="dispute-details">
                        <div class="dispute-player">
                            <h4><%= match.blue_username %> (Blue)</h4>
                            <p>Reportó como ganador: <%= match.blue_reported_winner === match.blue_summoner_id ? match.blue_username + ' (Blue)' : match.red_username + ' (Red)' %></p>
                            
                            <% if (match.blue_proof_images) { %>
                                <div class="proof-images">
                                    <h5>Pruebas:</h5>
                                    <div class="image-gallery">
                                        <% JSON.parse(match.blue_proof_images).forEach(imagePath => { %>
                                            <a href="<%= imagePath %>" target="_blank">
                                                <img src="<%= imagePath %>" alt="Proof" class="proof-thumbnail">
                                            </a>
                                        <% }); %>
                                    </div>
                                </div>
                            <% } %>
                        </div>
                        
                        <div class="dispute-player">
                            <h4><%= match.red_username %> (Red)</h4>
                            <p>Reportó como ganador: <%= match.red_reported_winner === match.blue_summoner_id ? match.blue_username + ' (Blue)' : match.red_username + ' (Red)' %></p>
                            
                            <% if (match.red_proof_images) { %>
                                <div class="proof-images">
                                    <h5>Pruebas:</h5>
                                    <div class="image-gallery">
                                        <% JSON.parse(match.red_proof_images).forEach(imagePath => { %>
                                            <a href="<%= imagePath %>" target="_blank">
                                                <img src="<%= imagePath %>" alt="Proof" class="proof-thumbnail">
                                            </a>
                                        <% }); %>
                                    </div>
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            <% } else { %>
                <% if ((isBluePlayer && !match.reported_by_blue) || (isRedPlayer && !match.reported_by_red)) { %>
                    <div class="result-form">
                        <h3>Reportar Resultado</h3>
                        <form id="resultForm" action="/submit-result/<%= match.id_game %>" method="POST" enctype="multipart/form-data">
                            <div class="form-group">
                                <label>¿Quién ganó la partida?</label>
                                <div class="radio-group">
                                    <div class="radio-item">
                                        <input type="radio" id="blue-winner" name="winner" value="<%= match.blue_summoner_id %>" required>
                                        <label for="blue-winner"><%= match.blue_username %> (Blue)</label>
                                    </div>
                                    <div class="radio-item">
                                        <input type="radio" id="red-winner" name="winner" value="<%= match.red_summoner_id %>" required>
                                        <label for="red-winner"><%= match.red_username %> (Red)</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="proof_images">Imágenes de prueba (opcional):</label>
                                <p class="form-help">Sube capturas de pantalla del resultado de la partida. Esto será necesario si hay una disputa.</p>
                                <input type="file" id="proof_images" name="proof_images" multiple accept="image/*">
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Enviar Resultado</button>
                            </div>
                        </form>
                    </div>
                <% } else if ((isBluePlayer && match.reported_by_blue) || (isRedPlayer && match.reported_by_red)) { %>
                    <div class="waiting-result">
                        <h3>Resultado Enviado</h3>
                        <p>Has reportado el resultado de esta partida. Esperando la confirmación del otro jugador.</p>
                        
                        <% if (isBluePlayer && match.reported_by_blue) { %>
                            <p>Reportaste como ganador: <%= match.blue_reported_winner === match.blue_summoner_id ? match.blue_username + ' (Blue)' : match.red_username + ' (Red)' %></p>
                        <% } else if (isRedPlayer && match.reported_by_red) { %>
                            <p>Reportaste como ganador: <%= match.red_reported_winner === match.blue_summoner_id ? match.blue_username + ' (Blue)' : match.red_username + ' (Red)' %></p>
                        <% } %>
                    </div>
                <% } %>
            <% } %>
        </div>
    </div>
</div>

<style>
/* Estilos para la página de resultados */
.match-info-sidebar p {
    margin: 8px 0;
    color: #ccc;
}

.players-info {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.player {
    padding: 10px;
    border-radius: 4px;
}

.blue-player {
    background-color: rgba(0, 100, 255, 0.2);
    border-left: 3px solid #0064ff;
}

.red-player {
    background-color: rgba(255, 0, 0, 0.2);
    border-left: 3px solid #ff0000;
}

.player-label {
    font-size: 0.8rem;
    color: #888;
    margin-bottom: 5px;
}

.player-name {
    font-weight: 600;
    color: #fff;
    margin-bottom: 5px;
}

.player-reputation {
    font-size: 0.8rem;
    color: #aaa;
}

.result-container {
    background-color: #1a1a1a;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
}

.result-form h3, .result-announced h3, .result-disputed h3, .waiting-result h3 {
    margin-top: 0;
    margin-bottom: 20px;
    color: #fff;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 10px;
    color: #ccc;
}

.form-help {
    font-size: 0.8rem;
    color: #888;
    margin-bottom: 10px;
}

.radio-group {
    display: flex;
    gap: 20px;
}

.radio-item {
    display: flex;
    align-items: center;
}

.radio-item input[type="radio"] {
    margin-right: 8px;
}

.form-actions {
    margin-top: 30px;
}

.btn-primary {
    background-color: #8a2be2;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
}

.btn-primary:hover {
    background-color: #9b4ddb;
}

.winner-announcement {
    display: flex;
    justify-content: center;
    margin: 30px 0;
}

.winner {
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    width: 60%;
}

.blue-winner {
    background-color: rgba(0, 100, 255, 0.2);
    border: 2px solid #0064ff;
}

.red-winner {
    background-color: rgba(255, 0, 0, 0.2);
    border: 2px solid #ff0000;
}

.winner-label {
    font-size: 1.2rem;
    color: #ccc;
    margin-bottom: 10px;
}

.winner-name {
    font-size: 1.5rem;
    font-weight: 700;
    color: #fff;
}

.dispute-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
}

.dispute-player {
    background-color: #2a2a2a;
    padding: 15px;
    border-radius: 8px;
}

.dispute-player h4 {
    margin-top: 0;
    margin-bottom: 10px;
    color: #fff;
}

.dispute-player p {
    color: #ccc;
    margin-bottom: 15px;
}

.proof-images h5 {
    margin-top: 0;
    margin-bottom: 10px;
    color: #ccc;
}

.image-gallery {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.proof-thumbnail {
    width: 100px;
    height: 100px;
    object-fit: cover;
    border-radius: 4px;
    cursor: pointer;
    transition: transform 0.2s ease;
}

.proof-thumbnail:hover {
    transform: scale(1.05);
}

.waiting-result {
    text-align: center;
    padding: 20px;
}

.waiting-result p {
    color: #ccc;
    margin-bottom: 10px;
}

.alert {
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 20px;
}

.alert-success {
    background-color: rgba(0, 128, 0, 0.2);
    border-left: 4px solid green;
    color: #ccc;
}

.alert-error {
    background-color: rgba(255, 0, 0, 0.2);
    border-left: 4px solid red;
    color: #ccc;
}

.alert-info {
    background-color: rgba(0, 100, 255, 0.2);
    border-left: 4px solid #0064ff;
    color: #ccc;
}

.user-result {
    margin: 20px 0;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
}

.result-message {
    padding: 15px;
    border-radius: 8px;
}

.result-message.win {
    background-color: rgba(0, 128, 0, 0.2);
    border: 1px solid green;
}

.result-message.loss {
    background-color: rgba(255, 0, 0, 0.2);
    border: 1px solid red;
}

.result-message h4 {
    margin-top: 0;
    margin-bottom: 10px;
    color: #fff;
}

.result-message p {
    color: #ccc;
    margin-bottom: 0;
}

.rate-opponent {
    margin-top: 30px;
    padding: 20px;
    background-color: #2a2a2a;
    border-radius: 8px;
}

.rate-opponent h4 {
    margin-top: 0;
    margin-bottom: 15px;
    color: #fff;
}

.rating-options {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 20px;
}

.rating-option {
    display: flex;
    align-items: center;
}

.rating-option input[type="radio"] {
    margin-right: 10px;
}

.already-rated {
    margin-top: 20px;
    text-align: center;
    color: #ccc;
}
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Previsualización de imágenes
        const fileInput = document.getElementById('proof_images');
        if (fileInput) {
            fileInput.addEventListener('change', function() {
                // Aquí podrías añadir código para previsualizar las imágenes seleccionadas
            });
        }
    });
</script>

<%- include('partials/footer') %>
